#!/usr/bin/env python

import logging
import os
import sys
import traceback
from flow.factories import general_factory
import flow.configuration

LOG = logging.getLogger()


def main(executable_name=None, logging_mode=None,
        config_filename=None, args=None):
    if config_filename is None:
        config_filename = os.getenv('FLOW_CONFIG')
    config = flow.configuration.load_config(config_filename)

    logging_config = config['logging_configurations'][logging_mode]
    flow.configuration.setup_logging(logging_config)

    exec_config = config['executables'][executable_name]
    command = general_factory(**exec_config)
    exit_code = command.run(*args)

    return exit_code


if __name__ == '__main__':
    args = flow.configuration.parse_arguments()

    exit_code = 1

    try:
        exit_code = main(executable_name=args.executable_name,
                logging_mode=args.logging_mode, config_filename=args.config,
                args=args.args)
    except:
        LOG.exception('Unhandled exception caught, exitting.')
        traceback.print_exc()

    sys.exit(exit_code)
